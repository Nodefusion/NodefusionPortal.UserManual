trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  NODE_VERSION: '20.x'
  BUILD_DIR: 'build'
  DEPLOY_BRANCH: 'gh-pages'

steps:
- checkout: self
  persistCredentials: true  # Required for System.AccessToken

# Install Node.js
- task: NodeTool@0
  inputs:
    versionSpec: '$(NODE_VERSION)'
  displayName: 'Install Node.js'

# Build the Docusaurus site
- script: |
    npm install
    npm run build
  displayName: 'Build Docusaurus site'

# Deploy to GitHub Pages
- script: |
    echo "üîß Configuring Git credentials"
    git config --global user.name "azure-pipelines"
    git config --global user.email "azure-pipelines@users.noreply.github.com"

    echo "üåê Cloning the gh-pages branch"
    git clone --branch $(DEPLOY_BRANCH) https://$(System.AccessToken)@github.com/$(Build.Repository.Name) out

    echo "‚ôªÔ∏è  Replacing contents"
    rm -rf out/*
    cp -r $(BUILD_DIR)/* out/

    cd out
    git add .
    git commit -m "Deployed from Azure Pipelines: $(Build.BuildId)" || echo "Nothing to commit"
    
    echo "üöÄ Pushing to gh-pages branch"
    git remote set-url origin https://$(System.AccessToken)@github.com/$(Build.Repository.Name)
    git push origin $(DEPLOY_BRANCH)
  displayName: 'Deploy to GitHub Pages'
  env:
    System.AccessToken: $(System.AccessToken)
