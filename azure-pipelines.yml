trigger:
  - main  # Or your default branch name

pool:
  vmImage: ubuntu-latest

variables:
  NODE_VERSION: '20.x'
  BUILD_DIR: 'build'
  DEPLOY_BRANCH: 'gh-pages'

steps:
- checkout: self
  persistCredentials: true  # Enables use of System.AccessToken

# Install Node.js
- task: NodeTool@0
  inputs:
    versionSpec: '$(NODE_VERSION)'
  displayName: 'Install Node.js'

# Install dependencies and build the site
- script: |
    npm install
    npm run build
  displayName: 'Build Docusaurus site'

# Deploy to GitHub Pages
- script: |
    echo "Configuring Git credentials"
    git config --global user.name "azure-pipelines"
    git config --global user.email "azure-pipelines@users.noreply.github.com"

    echo "Cloning gh-pages branch with auth"
    git clone --branch $(DEPLOY_BRANCH) https://$(System.AccessToken)@github.com/$(Build.Repository.Name).git out

    echo "Replacing content with built site"
    rm -rf out/*
    cp -r $(BUILD_DIR)/* out/

    cd out
    git add .
    git commit -m "Deployed from Azure Pipelines: $(Build.BuildId)"
    git push https://$(System.AccessToken)@github.com/$(Build.Repository.Name).git $(DEPLOY_BRANCH)
  displayName: 'Deploy to GitHub Pages'
  env:
    System.AccessToken: $(System.AccessToken)
